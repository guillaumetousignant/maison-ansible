- name: Set static IP address
  hosts: pi_hole

  tasks:
  - name: Change connection
    become: true
    ansible.builtin.shell: nmcli con mod "{{ connection_name }}" ipv4.addresses "{{ static_ip_address }}"/"{{ subnet_size }}" ipv4.method manual ipv4.gateway "{{ gateway }}" ipv4.dns "{{ dns_servers }}"
  - name: Restart connection
    become: true
    ansible.builtin.shell: nmcli con down "{{ connection_name }}" && nmcli con up "{{ connection_name }}"
    async: 100
    poll: 0
  - name: Change IP address of host
    set_fact:
      ansible_host: "{{ static_ip_address }}"
  - name: Wait for the interface to come back up
    local_action:
      module: wait_for
      host: "{{ ansible_host }}"
      port: 22
      delay: 10
      state: started
    register: wait_result

- name: Install Pi-hole
  hosts: pi_hole

  tasks:
  - name: Install Pi-hole executable
    become: true
    ansible.builtin.shell: curl -sSL https://install.pi-hole.net | bash /dev/stdin --unattended
    args:
      creates: /usr/local/bin/pihole

- name: Install Caddy
  hosts: pi_hole

  tasks:
  - name: Install Caddy package
    become: true
    ansible.builtin.apt:
      update_cache: yes
      pkg:
        - caddy

- name: Pi-hole config
  hosts: pi_hole

  tasks:
  - name: PXE boot config
    become: yes
    ansible.builtin.copy:
      dest: /etc/dnsmasq.d/98-pxe.conf
      backup: yes
      content: |
        dhcp-boot=pxelinux/pxelinux.0
        enable-tftp
        tftp-root=/var/lib/tftpboot
  - name: TFTP folder creation
    become: yes
    ansible.builtin.file:
      path: /var/lib/tftpboot
      state: directory
      mode: '0755'
  - name: PXE boot folder creation
    become: yes
    ansible.builtin.file:
      path: /var/lib/tftpboot/pxelinux
      state: directory
      mode: '0755'

- name: Caddy config
  hosts: pi_hole

  tasks:
  - name: Caddyfile creation
    become: yes
    ansible.builtin.copy:
      dest: /etc/caddy/Caddyfile
      backup: yes
      content: |
        :42042 {
                # Set this path to your site's directory.
                root * /var/www/pxe
        
                # Enable the static file server.
                file_server
        }
